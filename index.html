<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>קטלוג בשמי דלוקס סנס</title>
<meta name="description" content="בשמים בייצור פרטי • הזמנה ושאלות ב-WhatsApp" />
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet" />
<meta property="og:title" content="קטלוג בשמי דלוקס סנס" />
<meta property="og:description" content="בשמים בייצור פרטי • קנייה דרך WhatsApp" />
<meta property="og:type" content="website" />
<meta property="og:image" content="images/og.jpg" />
<link rel="icon" href="images/favicon.ico" />
<style>
  :root{
    --logo-h:160px; --bg:#f7f3ec; --card:#fff; --fg:#1a1a1a; --muted:#6f6a5f;
    --accent:#b07a2a; --border:#eadfce; --shadow:0 6px 18px rgba(50,24,0,.06);
    --s-1:6px; --s-2:10px; --s-3:14px; --s-4:18px; --s-5:22px; --input-h:42px;
  }
  *{box-sizing:border-box} html,body{margin:0}
  body{
    overflow-x:hidden;
    color:var(--fg); font-family:Assistant,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    -webkit-font-smoothing:antialiased;
    background-color:var(--bg);
    background-image:
      radial-gradient(1200px 500px at 15% -10%, #ffffff 0 40%, transparent 70%),
      radial-gradient(900px 400px at 110% 0%, #fff3e0 0 30%, transparent 70%),
      linear-gradient(#fff, var(--bg)),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 32 32"><g fill="none" stroke="%23eadfce" stroke-width=".35" opacity=".25"><path d="M0 16H32M16 0V32"/></g></svg>');
    background-size:auto,auto,auto,64px 64px; background-repeat:no-repeat,no-repeat,no-repeat,repeat;
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1160px;margin:0 auto;padding:0 16px 56px}
  header{text-align:center;padding:32px 16px 8px}
  .logo{display:block;margin:0 auto var(--s-2);height:var(--logo-h);max-width:90%;object-fit:contain}
  header h1{font-weight:800;font-size:clamp(26px,3.5vw,40px);margin:0 0 var(--s-1)}
  header p{margin:var(--s-1) 0;color:var(--muted);font-weight:400}
  .cta{display:inline-block;margin-top:var(--s-2);padding:12px 18px;border:1px solid var(--accent);border-radius:14px;font-weight:700;background:linear-gradient(#fff,#fff9f0);box-shadow:var(--shadow);transition:.2s}
  .cta:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(176,122,42,.12)}

  /* FAQ – מעט למעלה */
  .faq{margin:12px 0 18px}
  .faq h2{font-weight:700;font-size:20px;margin:0 0 var(--s-1)}
  .faq details{border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:8px 0;background:#fff;box-shadow:var(--shadow)}

  /* פילטרים */
  .filters{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;margin:0 0 22px}
  .filters .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .f-field{display:flex;align-items:center;gap:8px}
  .f-label{font-weight:700;font-size:14px;white-space:nowrap}
  .f-input,.f-select{height:var(--input-h);padding:0 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;min-width:200px}
  .f-input{min-width:240px}
  @media (max-width:700px){
    .filters .row{display:flex;flex-direction:column;align-items:stretch;gap:12px}
    .f-field{display:grid;grid-template-columns:1fr;grid-row-gap:6px}
    .f-label{margin:0 2px}
    .f-input,.f-select{width:100%;min-width:unset}
  }

  /* גריד מוצרים */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
  @media (max-width:1200px){.grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));}}
  @media (max-width:520px){.grid{grid-template-columns:1fr;gap:14px;justify-items:center}}

  .card{
    display:flex;flex-direction:column;background:var(--card);
    border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow);transition:.2s;
    min-height:620px;
  }
  .card:hover{transform:translateY(-3px);box-shadow:0 12px 24px rgba(32,18,0,.08)}

  /* קרוסלה */
  .imagebox{position:relative;border-radius:12px;overflow:hidden;background:#f1f1f1;height:240px}
  .slide{position:absolute;inset:0;opacity:0;transition:opacity .25s;z-index:1;pointer-events:none}
  .slide.active{opacity:1;pointer-events:auto}
  .slide img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .badge{position:absolute;top:10px;inset-inline-start:10px;background:#000a;color:#fff;font-size:12px;padding:4px 8px;border-radius:999px;backdrop-filter:blur(2px)}
  .cnav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 6px;direction:ltr;z-index:3;pointer-events:none}
  .cbtn{width:26px;height:26px;border-radius:999px;border:1px solid var(--border);background:#fff9f0;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);opacity:.9}
  .cbtn svg{width:13px;height:13px}
  .cbtn,.cbtn *{pointer-events:auto;cursor:pointer}
  .imagebox.single .cnav{display:none}
  /* placeholder – משולב לצורך “ריבוע ריק” בלבד */
  .placeholder{position:absolute;inset:0}

  .meta-row{display:flex;gap:8px;align-items:center;justify-content:center;margin:var(--s-2) 0 var(--s-2);flex-wrap:wrap}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px dashed var(--border);border-radius:999px;font-size:12px;color:var(--muted);background:#fff}

  .title{margin:var(--s-2) 0 calc(var(--s-3) + 10px);text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:7.8em;gap:6px}
  .t1{font-weight:800;font-size:clamp(15px,2.1vw,18px);line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;max-height:2.8em}
  .t2{font-weight:600;font-size:clamp(13px,1.7vw,15px);line-height:1.35;color:var(--muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;max-height:2.8em}
  .t3{font-weight:600;font-size:13px;color:var(--muted)}
  .t2 .insp{color:var(--accent);font-weight:800}

  .size-row{display:flex;gap:8px;align-items:center;margin:0 0 var(--s-3)}
  .size-label{font-weight:700}
  .size-select{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;direction:rtl;text-align:right;appearance:none;
    background-image:linear-gradient(45deg,transparent 50%,var(--accent) 50%),linear-gradient(135deg,var(--accent) 50%,transparent 50%),linear-gradient(to left,#fff,#fff);
    background-position:16px 50%,24px 50%,0 0;background-size:8px 8px,8px 8px,2.5em 100%;background-repeat:no-repeat;padding-left:48px}

  .price{margin:0 0 var(--s-2);align-items:baseline;gap:10px;color:var(--fg);display:flex;justify-content:center}
  .price-amount{font-weight:800;font-size:20px;letter-spacing:.02em}
  .price-sep{color:#b9a98f}
  .price-size{font-weight:600;font-size:14px;color:var(--muted)}

  .size-note{display:none;margin:0 0 var(--s-3);font-size:13px;color:var(--muted);font-weight:600;text-align:center;line-height:1.35}
  .size-note.show{display:block}

  .wa-btn{margin-top:auto;display:block;width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--accent);background:#fff;font-weight:700;transition:.2s;text-align:center}
  .wa-btn:hover{background:#fff3e0;transform:translateY(-1px)}
  .wa-btn.disabled{opacity:.55;pointer-events:auto}

  .toast{position:fixed;z-index:9999;padding:10px 14px;border-radius:12px;background:#111;color:#fff;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .empty{text-align:center;color:var(--muted);padding:20px 0;font-weight:700}

  @media (max-width:520px){
    .wrap{padding:0 12px 48px}
    .card{min-height:unset;max-width:440px;width:100%;margin:0 auto;padding:12px}
    .imagebox{height:min(62vw,340px)}
    .cnav{padding:0 0}
    .cnav .prev{transform:translateX(-8px)}
    .cnav .next{transform:translateX(8px)}
    .title{min-height:unset}
    .t1,.t2{display:block;max-height:none;-webkit-line-clamp:unset;overflow:visible;word-break:break-word}
    .t1{font-size:18px}
    .t2{font-size:14px}
    .t3{font-size:12.5px}
    .meta-row{justify-content:center}
    .price{margin:8px 0 10px}
    .wa-btn{margin-top:10px}
    .placeholder{font-size:12px}
  }
</style>
</head>
<body>
  <header class="wrap">
    <img src="images/logo.png" alt="לוגו המותג" class="logo" onerror="this.style.display='none'">
    <h1>קטלוג בשמי דלוקס סנס</h1>
    <p>ייצור פרטי בכמויות קטנות. בחירה, שאלות והזמנה דרך WhatsApp.</p>
    <a class="cta" id="waTop" target="_blank" rel="noopener">דברו איתי ב-WhatsApp</a>
  </header>

  <main class="wrap">
    <section class="faq">
      <h2>שאלות נפוצות</h2>
      <details><summary>איך מבצעים הזמנה?</summary><div>בוחרים נפח (100 מ״ל / 10 מ״ל / 5 מ״ל), המחיר יוצג, לוחצים על כפתור ה-WhatsApp וההודעה תתמלא אוטומטית.</div></details>
      <details><summary>דוגמיות</summary><div>5 מ״ל — טעימה קצרה • 10 מ״ל — מיכל למילוי-מחדש (Refillable) לנשיאה יומיומית.</div></details>
      <details><summary>משלוחים וזמני הכנה</summary><div>נשלח בד״כ תוך 1–3 ימי עסקים מרגע האישור. איסוף מתואם אפשרי.</div></details>
    </section>

    <!-- פילטרים -->
    <section class="filters" id="filters">
      <div class="row">
        <div class="f-field">
          <label class="f-label" for="f-q">חיפוש</label>
          <input id="f-q" class="f-input" type="search" placeholder="חפש/י לפי שם דיופ או השראה…"/>
        </div>
        <div class="f-field">
          <label class="f-label" for="f-brand">מותג השראה</label>
          <select id="f-brand" class="f-select"><option value="">הכל</option></select>
        </div>
        <div class="f-field">
          <label class="f-label" for="f-gender">מין</label>
          <select id="f-gender" class="f-select">
            <option value="">הכל</option><option>לגבר</option><option>לאישה</option><option>יוניסקס</option>
          </select>
        </div>
        <div class="f-field">
          <label class="f-label" for="f-sort">סידור</label>
          <select id="f-sort" class="f-select">
            <option value="">ברירת מחדל</option>
            <option value="p_asc">מחיר 100 מ״ל — נמוך→גבוה</option>
            <option value="p_desc">מחיר 100 מ״ל — גבוה→נמוך</option>
          </select>
        </div>
      </div>
    </section>

    <section class="grid" id="products"></section>
    <div id="empty" class="empty" style="display:none">לא נמצאו מוצרים בהתאמה לסינון</div>
  </main>

  <footer class="wrap"><div>© 2025 שם המותג • הזמנה דרך WhatsApp בלבד • פרטי קשר: example@mail.com • 050-0000000</div></footer>

  <!-- Lightbox / Zoom -->
  <div id="lightbox" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999;">
    <div style="position:relative;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;gap:10px;align-items:center;">
      <img id="lb-img" alt="" style="max-width:95vw;max-height:80vh;object-fit:contain;transform-origin:center center;"/>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button id="lb-prev"  style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">‹ הקודם</button>
        <button id="lb-next"  style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">הבא ›</button>
        <button id="lb-zoom-in"  style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">+</button>
        <button id="lb-zoom-out" style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">−</button>
        <button id="lb-reset"    style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">איפוס</button>
        <button id="lb-close"    style="padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#fff">סגור</button>
      </div>
    </div>
  </div>

<script>
const WA_PHONE = "972508939729";
const CSV_URL  = "data/perfumes.csv";

/* ===== utils ===== */
function round5(x){ return Math.round(x/5)*5; }
function hashNum(str){ let h=0; for(let i=0;i<str.length;i++) h=((h<<5)-h)+str.charCodeAt(i)|0; return (Math.abs(h)%1000)/1000; }
function deriveBasePrice100(slug){ return round5(170 + hashNum(slug)*70); }
function derive10ml(p100){ return Math.max(35, round5(p100*0.32)); }
function derive5ml(p100){ return Math.max(20, round5(p100*0.18)); }

function slugify(s){
  if(!s) return "";
  const from="ÁÀÂÄÃÅáàâäãåÉÈÊËéèêëÍÌÎÏíìîïÓÒÔÖÕóòôöõÚÙÛÜúùûüÇçÑñŸÿŽžŠš’‘“”";
  const to  ="AAAAAAaaaaaaEEEEeeeeIIIIiiiiOOOOOoooooUUUUuuuuCcNnYyZzSs----";
  let out=s;
  for(let i=0;i<from.length;i++){ out=out.replaceAll(from[i],to[i]); }
  out = out.normalize?.("NFKD").replace(/[\u0300-\u036f]/g,"") || out;
  out = out.toLowerCase().replace(/['\"`´]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");
  return out;
}
function rawSlug(s){
  if(!s) return "";
  return s.trim().toLowerCase().replace(/\s+/g,"-").replace(/[\/\\]/g,"-").replace(/-{2,}/g,"-").replace(/^-|-$/g,"");
}
function showToast(msg, nearEl){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  const r=nearEl.getBoundingClientRect();
  t.style.top=Math.max(10,r.top-46)+'px';
  t.style.left=Math.max(10,Math.min(r.left+r.width/2-80,window.innerWidth-160))+'px';
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200);},1600);
}

/* ===== CSV ===== */
async function loadCSV(url){
  const res = await fetch(url,{cache:"no-store"});
  if(!res.ok){ console.error("CSV fetch failed",res.status); return {headers:[],rows:[]}; }
  const text=(await res.text()).replace(/^\uFEFF/,"");
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
  let headers=[]; const rows=[];
  function parseLine(line){
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch=='"' && q && nx=='"'){cur+='"'; i++; continue;}
      if(ch=='"'){q=!q; continue;}
      if(ch==',' && !q){out.push(cur); cur=""; continue;}
      cur+=ch;
    }
    out.push(cur); return out.map(s=>s.trim());
  }
  lines.forEach((ln,i)=>{ const cells=parseLine(ln); if(i===0) headers=cells; else{ const o={}; cells.forEach((v,j)=>o[headers[j]||`col${j}`]=v); rows.push(o);} });
  return {headers,rows};
}

/* ===== parsing title ===== */
const BRAND_ALIASES=["Thomas Kosmala","Xerjoff","Ex Nihilo","By Kilian","Kilian","Tom Ford","Gucci","Prada","Narciso Rodriguez","Parfums De Marly","Parfums de Marly","Carolina Herrera","Jean Paul Gaultier","Paco Rabanne","Giorgio Armani","Yves Saint Laurent","Louis Vuitton","Amouage","Kayali Fragrances","Kayali","Stéphane Humbert Lucas 777","Stéphane Humbert Lucas","Dior","Valentino"];
function normalizeBrand(raw){ if(!raw) return ""; let s=raw.trim().replace(/^By\s+/i,""); if(/By\s+Kilian/i.test(raw)||/^Kilian$/i.test(s)) s="Kilian"; return s; }

function parseFromLongTitle(longTitle){
  const norm=longTitle.replaceAll("בהשראת בהשראת","בהשראת");
  const [left, rightPart=""]=norm.split("|").map(s=>s?.trim()||"");
  let dupeTitle=left, inspStr="";
  if(left.includes("בהשראת")){ const parts=left.split("בהשראת"); dupeTitle=(parts[0]||"").trim(); inspStr=(parts[1]||"").trim(); }
  else if(left.includes("Louis Vuitton")&&left.includes("Ombre Nomade")){ inspStr="Louis Vuitton Ombre Nomade"; dupeTitle=left.replace("Louis Vuitton Ombre Nomade","").trim(); }
  let gender=""; if(/בושם\s+יוניסקס/.test(rightPart)) gender="יוניסקס"; else if(/בושם\s+לאישה/.test(rightPart)) gender="לאישה"; else if(/בושם\s+לגבר/.test(rightPart)) gender="לגבר";
  let inspBrand="",inspProduct="";
  if(/^Delilah Pour Femme/i.test(dupeTitle)){ inspBrand="Delina"; inspProduct="Delina"; }
  else{
    let found=""; for(const b of [...BRAND_ALIASES].sort((a,b)=>b.length-a.length)){ if(inspStr.toLowerCase().includes(b.toLowerCase())){ found=b; break; } }
    if(found){ inspBrand=normalizeBrand(found); const productRaw=inspStr.replace(new RegExp(found,"i"),"").replace(/\b[Bb]y\b/,"").trim(); inspProduct=productRaw; }
    else inspProduct=inspStr;
  }
  const HOUSE_TOKENS=["Fragrance Deluxe","Fragrance Delux","Fragrance World","Maison Legend","Mayson Legend","Maison Alhambra","Lattafa","Paris Corner","by"];
  let dupeName=dupeTitle; HOUSE_TOKENS.forEach(tok=> dupeName=dupeName.replace(new RegExp(tok,"ig"),"").trim());
  return {dupeName,dupeTitle,inspBrand,inspProduct,inspStr,gender,genderText:rightPart,longTitle:norm};
}

/* ===== filename candidates ===== */
function candidateBasesForDupe(dupeName,dupeTitle){
  const set=new Set(); const add=v=>{ if(v){ set.add(`images/${slugify(v)}`); set.add(`images/${rawSlug(v)}`); } };
  add(dupeName); add(dupeTitle);
  return Array.from(set);
}
function candidateBasesForInsp(inspBrand,inspProduct,inspStr){
  const set=new Set(); const add=v=>{ if(v){ set.add(`images/${slugify(v)}`); set.add(`images/${rawSlug(v)}`); } };
  const both1=`${inspBrand||""} ${inspProduct||""}`.trim();
  const both2=`${inspProduct||""} ${inspBrand||""}`.trim();
  const firstBrandWord=(inspBrand||"").split(/\s+/)[0]||"";
  const prodPlusFirstBrand=`${inspProduct||""} ${firstBrandWord}`.trim();
  add(both1); add(both2); add(prodPlusFirstBrand); add(inspStr);
  const prodTokens=(inspProduct||"").trim().split(/\s+/);
  if(prodTokens.length>=2){
    const last2=prodTokens.slice(-2).join(" ");
    const last3=prodTokens.slice(-3).join(" ");
    add(`${last2} ${inspBrand||""}`.trim());
    add(`${last3} ${inspBrand||""}`.trim());
  }
  return Array.from(set);
}
function tryLoadOne(img,base,ok,fail){ const exts=[".jpg",".jpeg",".png",".webp"]; let i=0; img.onload=()=>ok(); img.onerror=()=>{ i++; if(i<exts.length){ img.src=base+exts[i]; } else fail(); }; img.src=base+exts[0]; }

/* ===== carousel + zoom ===== */
function buildCarousel(container,p){
  container.innerHTML="";
  const holders=[];
  function makeSlide(label){ const s=document.createElement('div'); s.className='slide'; const img=document.createElement('img'); const badge=document.createElement('span'); badge.className='badge'; badge.textContent=label; s.appendChild(img); s.appendChild(badge); return {s,img}; }

  const dupeCands=candidateBasesForDupe(p.dupeName,p.dupeTitle);
  const inspCands=candidateBasesForInsp(p.inspBrand,p.inspProduct,p.inspStr);

  let loadedSlides=[];
  function addWithCandidates(label,cands){
    if(!cands.length) return;
    const {s,img}=makeSlide(label); container.appendChild(s);
    let j=0; function tryNext(){ if(j>=cands.length){ s.dataset.missing="1"; return; }
      const base=cands[j++]; tryLoadOne(img,base,()=>{ s.dataset.loaded="1"; loadedSlides.push(s); activate(); },tryNext); }
    tryNext(); holders.push(s);
  }
  addWithCandidates("מוצר",dupeCands);
  addWithCandidates("השראה",inspCands);

  /* placeholder ריק – רק ריבוע עד טעינה / חוסר תמונות */
  const ph=document.createElement('div'); ph.className='placeholder'; container.appendChild(ph);

  const nav=document.createElement('div'); nav.className='cnav';
  nav.innerHTML=`<button class="cbtn prev" aria-label="הקודם"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                 <button class="cbtn next" aria-label="הבא"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg></button>`;
  container.appendChild(nav);

  let idx=0;
  function activate(){
    loadedSlides=holders.filter(s=>s.dataset.loaded==="1");
    if(!loadedSlides.length){ nav.style.display='none'; container.classList.add('single'); return; }
    ph.style.display='none';
    loadedSlides.forEach((s,i)=>s.classList.toggle('active',i===0));
    container.classList.toggle('single',loadedSlides.length<=1);

    const srcs=loadedSlides.map(s=>s.querySelector('img').src);
    loadedSlides.forEach((s,i)=>{
      const img=s.querySelector('img');
      img.onclick=()=>openLB(srcs,i);
    });
  }
  function goto(n){
    if(!loadedSlides.length) return;
    idx=(n+loadedSlides.length)%loadedSlides.length;
    loadedSlides.forEach((s,i)=>s.classList.toggle('active',i===idx));
  }
  nav.querySelector('.prev').addEventListener('click',()=>goto(idx-1));
  nav.querySelector('.next').addEventListener('click',()=>goto(idx+1));

  console.debug("IMAGE CANDIDATES:",{dupe:dupeCands,insp:inspCands});
}

/* Lightbox / Zoom */
const lb=document.getElementById('lightbox');
const lbImg=document.getElementById('lb-img');
const lbIn=document.getElementById('lb-zoom-in');
const lbOut=document.getElementById('lb-zoom-out');
const lbReset=document.getElementById('lb-reset');
const lbClose=document.getElementById('lb-close');
const lbPrev=document.getElementById('lb-prev');
const lbNext=document.getElementById('lb-next');
let lbScale=1, lbList=[], lbIndex=0;
function showCurrent(){ lbImg.src=lbList[lbIndex]; lbScale=1; lbImg.style.transform='scale(1)'; }
function openLB(list,index){ lbList=list||[]; lbIndex=index||0; if(!lbList.length) return; showCurrent(); lb.style.display='flex'; document.body.style.overflow='hidden'; }
function closeLB(){ lb.style.display='none'; lbImg.src=""; document.body.style.overflow=''; }
lbIn.addEventListener('click',()=>{ lbScale=Math.min(5,lbScale+0.2); lbImg.style.transform=`scale(${lbScale})`; });
lbOut.addEventListener('click',()=>{ lbScale=Math.max(1,lbScale-0.2); lbImg.style.transform=`scale(${lbScale})`; });
lbReset.addEventListener('click',()=>{ lbScale=1; lbImg.style.transform='scale(1)'; });
lbClose.addEventListener('click',closeLB);
lb.addEventListener('click',e=>{ if(e.target===lb) closeLB(); });
lbPrev.addEventListener('click',()=>{ if(!lbList.length) return; lbIndex=(lbIndex-1+lbList.length)%lbList.length; showCurrent(); });
lbNext.addEventListener('click',()=>{ if(!lbList.length) return; lbIndex=(lbIndex+1)%lbList.length; showCurrent(); });
window.addEventListener('keydown',e=>{
  if(lb.style.display!=='flex') return;
  if(e.key==='ArrowLeft') lbPrev.click();
  if(e.key==='ArrowRight') lbNext.click();
  if(e.key==='Escape') lbClose.click();
});

/* WhatsApp */
function buildWaHref(p,sizeLabel,price){
  const lines=[
    "היי! מעוניין/ת בבושם:", p.longTitle,
    sizeLabel?`נפח: ${sizeLabel}`:null,
    price?`מחיר מוצג: ₪${price}`:null,
    "אשמח לפרטים/הזמנה."
  ].filter(Boolean).join("\n");
  return `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(lines)}`;
}

/* Render */
const selectedById={};
function renderProducts(list){
  const el=document.getElementById('products'), empty=document.getElementById('empty');
  if(!list.length){ el.innerHTML=""; empty.style.display='block'; return; } empty.style.display='none';
  el.innerHTML=list.map(p=>{
    const t1=p.dupeTitle;
    const t2=p.inspStr?`בהשראת <span class="insp">${p.inspStr}</span>`:"";
    const t3=p.genderText||"";
    return `
    <article class="card" data-id="${p.id}">
      <div class="imagebox"></div>
      <div class="meta-row">
        ${p.inspBrand?`<span class="tag">מותג השראה: ${p.inspBrand}</span>`:""}
        ${p.gender?`<span class="tag">${p.gender}</span>`:""}
      </div>
      <div class="title">
        <div class="t1">${t1}</div>
        <div class="t2">${t2}</div>
        <div class="t3">${t3}</div>
      </div>
      <div class="size-row">
        <span class="size-label">נפח</span>
        <select class="size-select" aria-label="בחר נפח">
          <option value="" ${!selectedById[p.id]?'selected':''} disabled>בחר נפח…</option>
          <option value="100" ${selectedById[p.id]==="100"?'selected':''}>100 מ״ל</option>
          <option value="10"  ${selectedById[p.id]==="10" ?'selected':''}>10 מ״ל (כולל שפריצר)</option>
          <option value="5"   ${selectedById[p.id]==="5"  ?'selected':''}>5 מ״ל</option>
        </select>
      </div>
      <div class="price" aria-live="polite">
        <span class="price-amount">₪<span class="price-val">${p.price["100"]}</span></span>
        <span class="price-sep">·</span>
        <span class="price-size">100 מ״ל</span>
      </div>
      <p class="size-note"></p>
      <a class="wa-btn ${selectedById[p.id]?'':'disabled'}" href="#" target="_blank" rel="noopener">הזמנה/שאלה ב-WhatsApp</a>
    </article>`;
  }).join('');

  document.querySelectorAll('.card').forEach(card=>{
    const pid=+card.dataset.id; const p=list.find(x=>x.id===pid);
    const select=card.querySelector('.size-select');
    const priceVal=card.querySelector('.price-val'); const priceSize=card.querySelector('.price-size'); const priceSep=card.querySelector('.price-sep');
    const noteEl=card.querySelector('.size-note'); const waBtn=card.querySelector('.wa-btn'); const box=card.querySelector('.imagebox');

    buildCarousel(box,p);
    waBtn.addEventListener('click',e=>{ if(waBtn.classList.contains('disabled')){ e.preventDefault(); showToast('בחר/י נפח קודם 🙂',waBtn);} });

    if(selectedById[pid]) applySize(selectedById[pid]); else { priceVal.textContent=p.price["100"]; priceSize.textContent="100 מ״ל"; }
    select.addEventListener('change',e=>applySize(e.target.value));

    function applySize(v){
      selectedById[pid]=v; const price=p.price[v];
      priceVal.textContent=price; const sizeHe=(v==="100"?"100 מ״ל":v==="10"?"10 מ״ל":"5 מ״ל");
      priceSize.textContent=sizeHe; priceSep.style.display=price&&sizeHe?'inline':'none';
      if(v==="10"){ noteEl.textContent="כולל שפריצר למילוי-מחדש (Refillable)"; noteEl.classList.add('show'); }
      else{ noteEl.textContent=""; noteEl.classList.remove('show'); }
      waBtn.href=buildWaHref(p,sizeHe,price); waBtn.classList.remove('disabled');
    }
  });
}

/* Filters */
function unique(list,get){ return Array.from(new Set(list.map(get).filter(Boolean))); }
function renderBrandOptions(list){
  const sel=document.getElementById('f-brand'), prev=sel.value;
  sel.innerHTML=`<option value="">הכל</option>`;
  unique(list,p=>p.inspBrand).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; sel.appendChild(o); });
  if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
}
function applyFilters(all){
  const q=document.getElementById('f-q').value.trim().toLowerCase();
  const brand=document.getElementById('f-brand').value;
  const genderSel=document.getElementById('f-gender').value;
  const sort=document.getElementById('f-sort').value;

  let list=all.filter(p=>{
    const hay=(p.dupeTitle+" "+p.dupeName+" "+p.inspBrand+" "+p.inspProduct+" "+p.inspStr+" "+p.longTitle).toLowerCase();
    const okQ=!q||hay.includes(q), okB=!brand||p.inspBrand===brand, okG=!genderSel||p.gender===genderSel;
    return okQ&&okB&&okG;
  });
  if(sort==='p_asc')  list=list.slice().sort((a,b)=>(a.price["100"]||0)-(b.price["100"]||0));
  if(sort==='p_desc') list=list.slice().sort((a,b)=>(b.price["100"]||0)-(a.price["100"]||0));
  renderProducts(list);
}

/* map row */
function mapRow(row,idx){
  const longTitle=(row["שם מלא כותרת"]||row["Title"]||row["name"]||"").trim();
  const parsed=parseFromLongTitle(longTitle);
  const base=deriveBasePrice100(slugify(parsed.dupeName||parsed.dupeTitle||("p"+idx)));
  const price100=base, price10=derive10ml(base), price5=derive5ml(base);
  return {id:idx+1,longTitle:parsed.longTitle,dupeTitle:parsed.dupeTitle,dupeName:parsed.dupeName,inspBrand:parsed.inspBrand,inspProduct:parsed.inspProduct,inspStr:parsed.inspStr,gender:parsed.gender,genderText:parsed.genderText,price:{"100":price100,"10":price10,"5":price5}};
}

/* init */
function initTopWA(){ const waTop=document.getElementById('waTop'); if(waTop) waTop.href=`https://wa.me/${WA_PHONE}?text=${encodeURIComponent('היי! מעוניין/ת בבשמים. אשמח לפרטים על נפחים ודוגמיות.')}`; }
document.addEventListener('DOMContentLoaded',async()=>{
  initTopWA();
  const {rows}=await loadCSV(CSV_URL);
  if(!rows.length){ console.warn("CSV ריק או לא נטען"); document.getElementById('empty').style.display='block'; return; }
  const ALL=rows.map(mapRow);
  renderBrandOptions(ALL);
  renderProducts(ALL);
  document.getElementById('f-q').addEventListener('input',()=>applyFilters(ALL));
  document.getElementById('f-brand').addEventListener('change',()=>applyFilters(ALL));
  document.getElementById('f-gender').addEventListener('change',()=>applyFilters(ALL));
  document.getElementById('f-sort').addEventListener('change',()=>applyFilters(ALL));
});
</script>
</body>
</html>
