<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×§×˜×œ×•×’ ×‘×©××™ ×“×œ×•×§×¡ ×¡× ×¡</title>
<meta name="description" content="×‘×©××™× ×‘×™×™×¦×•×¨ ×¤×¨×˜×™ â€¢ ×”×–×× ×” ×•×©××œ×•×ª ×‘-WhatsApp" />
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet" />
<meta property="og:title" content="×§×˜×œ×•×’ ×‘×©××™ ×“×œ×•×§×¡ ×¡× ×¡" />
<meta property="og:description" content="×‘×©××™× ×‘×™×™×¦×•×¨ ×¤×¨×˜×™ â€¢ ×§× ×™×™×” ×“×¨×š WhatsApp" />
<meta property="og:type" content="website" />
<meta property="og:image" content="images/og.jpg" />
<link rel="icon" href="images/favicon.ico" />
<style>
  :root{
    --logo-h: 160px; --bg:#f7f3ec; --card:#fff; --fg:#1a1a1a; --muted:#6f6a5f;
    --accent:#b07a2a; --border:#eadfce; --shadow:0 6px 18px rgba(50,24,0,.06);
    --s-1:6px; --s-2:10px; --s-3:14px; --s-4:18px; --s-5:22px; --input-h:42px;
  }
  *{box-sizing:border-box} html,body{margin:0}
  body{
    color:var(--fg); font-family:Assistant,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased;
    background-color:var(--bg);
    background-image:
      radial-gradient(1200px 500px at 15% -10%, #ffffff 0 40%, transparent 70%),
      radial-gradient(900px 400px at 110% 0%, #fff3e0 0 30%, transparent 70%),
      linear-gradient(#fff, var(--bg)),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 32 32"><g fill="none" stroke="%23eadfce" stroke-width=".35" opacity=".25"><path d="M0 16H32M16 0V32"/></g></svg>');
    background-size:auto,auto,auto,64px 64px; background-repeat:no-repeat,no-repeat,no-repeat,repeat;
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1160px;margin:0 auto;padding:0 16px 56px}
  header{text-align:center;padding:32px 16px 8px}
  .logo{display:block;margin:0 auto var(--s-2);height:var(--logo-h);max-width:90%;object-fit:contain}
  header h1{font-weight:800;font-size:clamp(26px,3.5vw,40px);margin:0 0 var(--s-1)}
  header p{margin:var(--s-1) 0;color:var(--muted);font-weight:400}
  .cta{display:inline-block;margin-top:var(--s-2);padding:12px 18px;border:1px solid var(--accent);border-radius:14px;font-weight:700;background:linear-gradient(#fff,#fff9f0);box-shadow:var(--shadow);transition:.2s}
  .cta:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(176,122,42,.12)}

  .faq{margin:20px 0 20px}
  .faq h2{font-weight:700;font-size:20px;margin:0 0 var(--s-1)}
  .faq details{border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:8px 0;background:#fff;box-shadow:var(--shadow)}

  .filters{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;margin:0 0 22px}
  .filters .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .f-field{display:flex;align-items:center;gap:8px}
  .f-label{font-weight:700;font-size:14px}
  .f-input,.f-select{height:var(--input-h);padding:0 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;min-width:200px}
  .f-input{min-width:240px}
  @media (max-width:700px){.filters .row{flex-direction:column;align-items:stretch}.f-input,.f-select{width:100%;min-width:unset}.f-field{width:100%}}

  .grid.masonry{column-count:4;column-gap:var(--s-4)}
  @media (max-width:1200px){.grid.masonry{column-count:3}}
  @media (max-width:800px){.grid.masonry{column-count:2}}
  @media (max-width:520px){.grid.masonry{column-count:2}}

  .card{display:inline-block;width:100%;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow);transition:.2s;margin:0 0 var(--s-4);break-inside:avoid}
  .card:hover{transform:translateY(-3px);box-shadow:0 12px 24px rgba(32,18,0,.08)}

  .imagebox{position:relative;border-radius:12px;overflow:hidden;background:#f1f1f1;height:280px}
  .slide{position:absolute;inset:0;opacity:0;transition:opacity .2s}
  .slide.active{opacity:1}
  .slide img{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;top:10px;inset-inline-start:10px;background:#000a;color:#fff;font-size:12px;padding:4px 8px;border-radius:999px;backdrop-filter:blur(2px)}
  .cnav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 8px;pointer-events:none;direction:ltr}
  .cbtn{pointer-events:auto;width:40px;height:40px;border-radius:999px;border:1px solid var(--border);background:#fff9f0;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
  .cbtn svg{width:18px;height:18px}
  .imagebox.single .cnav{display:none}

  .meta-row{display:flex;gap:8px;align-items:center;justify-content:center;margin:var(--s-2) 0 var(--s-2)}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px dashed var(--border);border-radius:999px;font-size:12px;color:var(--muted);background:#fff}

  .card h3{margin:var(--s-2) 0 var(--s-2);font-size:16px;line-height:1.35;font-weight:700;text-align:center;font-family:Assistant,Inter,Arial,sans-serif}

  .size-row{display:flex;gap:8px;align-items:center;margin:0 0 var(--s-3)}
  .size-label{font-weight:700}
  .size-select{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;direction:rtl;text-align:right;appearance:none;
    background-image:linear-gradient(45deg,transparent 50%,var(--accent) 50%),linear-gradient(135deg,var(--accent) 50%,transparent 50%),linear-gradient(to left,#fff,#fff);
    background-position:16px 50%,24px 50%,0 0;background-size:8px 8px,8px 8px,2.5em 100%;background-repeat:no-repeat;padding-left:48px}

  .price{margin:0 0 var(--s-2);align-items:baseline;gap:10px;color:var(--fg);display:flex}
  .price-amount{font-weight:800;font-size:20px;letter-spacing:.02em}
  .price-sep{color:#b9a98f}
  .price-size{font-weight:600;font-size:14px;color:var(--muted)}
  @media (max-width:600px){.price{justify-content:center}}

  .size-note{display:none;margin:0 0 var(--s-3);font-size:13px;color:var(--muted);font-weight:600;text-align:center;line-height:1.35}
  .size-note.show{display:block}

  .wa-btn{margin-top:auto;display:inline-block;padding:12px 16px;border-radius:12px;border:1px solid var(--accent);background:#fff;font-weight:700;transition:.2s;text-align:center}
  .wa-btn:hover{background:#fff3e0;transform:translateY(-1px)}
  .wa-btn.disabled{opacity:.55;pointer-events:auto}
  @media (max-width:600px){.wa-btn{display:block;width:100%}}

  .toast{position:fixed;z-index:9999;padding:10px 14px;border-radius:12px;background:#111;color:#fff;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}

  .empty{text-align:center;color:var(--muted);padding:20px 0;font-weight:700}
</style>
</head>
<body>
  <header class="wrap">
    <img src="images/logo.png" alt="×œ×•×’×• ×”××•×ª×’" class="logo" onerror="this.style.display='none'">
    <h1>×§×˜×œ×•×’ ×‘×©××™ ×“×œ×•×§×¡ ×¡× ×¡</h1>
    <p>×™×™×¦×•×¨ ×¤×¨×˜×™ ×‘×›××•×™×•×ª ×§×˜× ×•×ª. ×‘×—×™×¨×”, ×©××œ×•×ª ×•×”×–×× ×” ×“×¨×š WhatsApp.</p>
    <a class="cta" id="waTop" target="_blank" rel="noopener">×“×‘×¨×• ××™×ª×™ ×‘-WhatsApp</a>
  </header>

  <main class="wrap">
    <section class="faq">
      <h2>×©××œ×•×ª × ×¤×•×¦×•×ª</h2>
      <details><summary>××™×š ××‘×¦×¢×™× ×”×–×× ×”?</summary><div>×‘×•×—×¨×™× × ×¤×— (100 ××´×œ / 10 ××´×œ / 5 ××´×œ), ×”××—×™×¨ ×™×•×¦×’, ×œ×•×—×¦×™× ×¢×œ ×›×¤×ª×•×¨ ×”-WhatsApp ×•×”×”×•×“×¢×” ×ª×ª××œ× ××•×˜×•××˜×™×ª.</div></details>
      <details><summary>×“×•×’××™×•×ª</summary><div>5 ××´×œ â€” ×˜×¢×™××” ×§×¦×¨×” â€¢ 10 ××´×œ â€” ××™×›×œ ×œ××™×œ×•×™-××—×“×© (Refillable) ×œ× ×©×™××” ×™×•××™×•××™×ª.</div></details>
      <details><summary>××©×œ×•×—×™× ×•×–×× ×™ ×”×›× ×”</summary><div>× ×©×œ×— ×‘×“×´×› ×ª×•×š 1â€“3 ×™××™ ×¢×¡×§×™× ××¨×’×¢ ×”××™×©×•×¨. ××™×¡×•×£ ××ª×•×× ××¤×©×¨×™.</div></details>
    </section>

    <section class="filters" id="filters">
      <div class="row">
        <div class="f-field"><label class="f-label" for="f-q">×—×™×¤×•×©</label><input id="f-q" class="f-input" type="search" placeholder="×—×¤×©/×™ ×œ×¤×™ ×©× ×“×™×•×¤ ××• ×”×©×¨××”â€¦"/></div>
        <div class="f-field"><label class="f-label" for="f-brand">××•×ª×’ ×”×©×¨××”</label><select id="f-brand" class="f-select"><option value="">×”×›×œ</option></select></div>
        <div class="f-field"><label class="f-label" for="f-sort">×¡×™×“×•×¨</label><select id="f-sort" class="f-select"><option value="">×‘×¨×™×¨×ª ××—×“×œ</option><option value="p_asc">××—×™×¨ 100 ××´×œ â€” × ××•×šâ†’×’×‘×•×”</option><option value="p_desc">××—×™×¨ 100 ××´×œ â€” ×’×‘×•×”â†’× ××•×š</option></select></div>
      </div>
    </section>

    <section class="grid masonry" id="products"></section>
    <div id="empty" class="empty" style="display:none">×œ× × ××¦××• ××•×¦×¨×™× ×‘×”×ª×××” ×œ×¡×™× ×•×Ÿ</div>
  </main>

  <footer class="wrap"><div>Â© 2025 ×©× ×”××•×ª×’ â€¢ ×”×–×× ×” ×“×¨×š WhatsApp ×‘×œ×‘×“ â€¢ ×¤×¨×˜×™ ×§×©×¨: example@mail.com â€¢ 050-0000000</div></footer>

<script>
const WA_PHONE = "972508939729";
const CSV_URL  = "data/perfumes.csv";

/* -------- utils -------- */
function round5(x){ return Math.round(x/5)*5; }
function hashNum(str){ let h=0; for(let i=0;i<str.length;i++) h=((h<<5)-h)+str.charCodeAt(i)|0; return (Math.abs(h)%1000)/1000; }
function deriveBasePrice100(slug){ return round5(170 + hashNum(slug)*70); }
function derive10ml(p100){ return Math.max(35, round5(p100*0.32)); }
function derive5ml(p100){ return Math.max(20, round5(p100*0.18)); }

function slugify(s){
  if(!s) return "";
  const from="ÃÃ€Ã‚Ã„ÃƒÃ…Ã¡Ã Ã¢Ã¤Ã£Ã¥Ã‰ÃˆÃŠÃ‹Ã©Ã¨ÃªÃ«ÃÃŒÃÃÃ­Ã¬Ã®Ã¯Ã“Ã’Ã”Ã–Ã•Ã³Ã²Ã´Ã¶ÃµÃšÃ™Ã›ÃœÃºÃ¹Ã»Ã¼Ã‡Ã§Ã‘Ã±Å¸Ã¿Å½Å¾Å Å¡";
  const to  ="AAAAAAaaaaaaEEEEeeeeIIIIiiiiOOOOOoooooUUUUuuuuCcNnYyZzSs";
  let out=s;
  for(let i=0;i<from.length;i++){ out=out.replaceAll(from[i],to[i]); }
  out = out.normalize?.("NFKD").replace(/[\u0300-\u036f]/g,"") || out;
  out = out.toLowerCase().replace(/['\"â€™`Â´]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");
  return out;
}

function showToast(msg, nearEl){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  const r=nearEl.getBoundingClientRect();
  t.style.top=Math.max(10,r.top-46)+'px'; t.style.left=Math.max(10,Math.min(r.left+r.width/2-80,window.innerWidth-160))+'px';
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200);},1600);
}

/* -------- CSV reader (supports quotes) -------- */
async function loadCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok){ console.error("CSV fetch failed", res.status); return {headers:[],rows:[]}; }
  const text = (await res.text()).replace(/^\uFEFF/,"");
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  let headers=[]; const rows=[];
  function parseLine(line){
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch=='"' && q && nx=='"'){cur+='"'; i++; continue;}
      if(ch=='"'){q=!q; continue;}
      if(ch==',' && !q){out.push(cur); cur=""; continue;}
      cur+=ch;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }
  lines.forEach((ln,idx)=>{
    const cells=parseLine(ln);
    if(idx===0) headers=cells;
    else{
      const obj={};
      cells.forEach((v,i)=> obj[headers[i]||`col${i}`]=v);
      rows.push(obj);
    }
  });
  return {headers,rows};
}

/* -------- parse from long title (fallback) -------- */
const BRAND_ALIASES = [
  "Thomas Kosmala","Xerjoff","Ex Nihilo","By Kilian","Kilian","Tom Ford","Gucci","Prada",
  "Narciso Rodriguez","Parfums De Marly","Parfums de Marly","Carolina Herrera","Jean Paul Gaultier",
  "Paco Rabanne","Giorgio Armani","Yves Saint Laurent","Louis Vuitton","Amouage",
  "Kayali Fragrances","Kayali","StÃ©phane Humbert Lucas 777","StÃ©phane Humbert Lucas"
];

function parseFromLongTitle(longTitle){
  // format: "<DUPE> ×‘×”×©×¨××ª <INSP> | ×‘×•×©× <××™×Ÿ>"
  const norm = longTitle.replaceAll("×‘×”×©×¨××ª ×‘×”×©×¨××ª","×‘×”×©×¨××ª");
  const [left, rightPart=""] = norm.split("|").map(s=>s?.trim()||"");
  let dupeTitle = left;
  let inspStr = "";
  if(left.includes("×‘×”×©×¨××ª")){
    const parts = left.split("×‘×”×©×¨××ª");
    dupeTitle = (parts[0]||"").trim();
    inspStr = (parts[1]||"").trim();
  } else {
    // special case without "×‘×”×©×¨××ª"
    if(left.includes("Louis Vuitton") && left.includes("Ombre Nomade")){
      inspStr = "Louis Vuitton Ombre Nomade";
      dupeTitle = left.replace("Louis Vuitton Ombre Nomade","").trim();
    }
  }

  // gender
  let gender = "";
  if(/×‘×•×©×\s+×™×•× ×™×¡×§×¡/.test(rightPart)) gender="×™×•× ×™×¡×§×¡";
  else if(/×‘×•×©×\s+×œ××™×©×”/.test(rightPart)) gender="×œ××™×©×”";
  else if(/×‘×•×©×\s+×œ×’×‘×¨/.test(rightPart)) gender="×œ×’×‘×¨";

  // special Delilah rule
  let inspBrand="", inspProduct="";
  if(/^Delilah Pour Femme/i.test(dupeTitle)){
    inspBrand = "Delina"; inspProduct = "Delina";
  } else {
    // find brand token inside inspStr
    let found="";
    for(const b of [...BRAND_ALIASES].sort((a,b)=>b.length-a.length)){
      if(inspStr.toLowerCase().includes(b.toLowerCase())){ found=b; break; }
    }
    if(found){
      inspBrand = (found.toLowerCase()==="kayali fragrances") ? "Kayali" : found;
      inspProduct = inspStr.replace(new RegExp(found,"i"),"").replace(/\b[Bb]y\b/,"").trim();
    } else {
      // brand unknown, all treated as product
      inspBrand=""; inspProduct=inspStr;
    }
  }

  // derive short dupe name for filenames (strip house tokens)
  const HOUSE_TOKENS = ["Fragrance Deluxe","Fragrance Delux","Fragrance World","Maison Legend","Mayson Legend","Maison Alhambra","Lattafa","Paris Corner","by"];
  let dupeName = dupeTitle;
  HOUSE_TOKENS.forEach(tok=> dupeName = dupeName.replace(new RegExp(tok,"ig"),"").trim());

  return {dupeName,inspBrand,inspProduct,gender,longTitle: norm};
}

/* -------- images + carousel -------- */
function createSmartSlide(label, baseNoExt){
  const slide=document.createElement('div'); slide.className='slide';
  const img=document.createElement('img'); const badge=document.createElement('span'); badge.className='badge'; badge.textContent=label;
  slide.appendChild(img); slide.appendChild(badge);
  const exts=[".jpg",".jpeg",".png",".webp"]; let i=0;
  function tryNext(){ if(i>=exts.length){ slide.dataset.missing="1"; return; } img.src=`${baseNoExt}${exts[i++]}`; }
  img.onerror=tryNext; tryNext(); return slide;
}
function buildCarousel(container, dupeSrcNoExt, inspSrcNoExt){
  container.innerHTML=""; const slides=[];
  if(dupeSrcNoExt) slides.push(createSmartSlide("××•×¦×¨", dupeSrcNoExt));
  if(inspSrcNoExt) slides.push(createSmartSlide("×”×©×¨××”", inspSrcNoExt));
  slides.forEach(s=>container.appendChild(s));
  if(!slides.length) return;
  function activateFirst(){
    const ok=slides.filter(s=>!s.dataset.missing); const t=ok[0]||slides[0];
    slides.forEach(s=>s.classList.toggle('active', s===t)); container.classList.toggle('single', ok.length<=1);
  }
  setTimeout(activateFirst,0);
  const nav=document.createElement('div'); nav.className='cnav';
  nav.innerHTML=`<button class="cbtn prev" aria-label="×”×§×•×“×"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                 <button class="cbtn next" aria-label="×”×‘×"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg></button>`;
  container.appendChild(nav);
  let idx=0;
  function vis(){ return slides.filter(s=>!s.dataset.missing); }
  function goto(n){ const v=vis(); if(!v.length) return; idx=(n+v.length)%v.length; v.forEach((s,i)=>s.classList.toggle('active', i===idx)); }
  nav.querySelector('.prev').addEventListener('click',()=>goto(idx-1));
  nav.querySelector('.next').addEventListener('click',()=>goto(idx+1));
}

/* -------- WhatsApp -------- */
function buildWaHref(p, sizeLabel, price){
  const lines = [
    "×”×™×™! ××¢×•× ×™×™×Ÿ/×ª ×‘×‘×•×©×:",
    p.longTitle,
    sizeLabel ? `× ×¤×—: ${sizeLabel}` : null,
    price ? `××—×™×¨ ××•×¦×’: â‚ª${price}` : null,
    "××©××— ×œ×¤×¨×˜×™×/×”×–×× ×”."
  ].filter(Boolean).join("\n");
  return `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(lines)}`;
}

/* -------- render -------- */
const selectedById = {};
function renderProducts(list){
  const el=document.getElementById('products'); const empty=document.getElementById('empty');
  if(!list.length){ el.innerHTML=""; empty.style.display='block'; return; } empty.style.display='none';

  el.innerHTML = list.map(p=>{
    const vol100 = p.price["100"];
    const dupeSlug = slugify(p.dupeName);
    const inspSlug = slugify(`${p.inspBrand} ${p.inspProduct}`.trim());
    return `
      <article class="card" data-id="${p.id}">
        <div class="imagebox"></div>
        <div class="meta-row">
          ${p.inspBrand ? `<span class="tag">××•×ª×’ ×”×©×¨××”: ${p.inspBrand}</span>` : ""}
          ${p.gender ? `<span class="tag">${p.gender}</span>` : ""}
        </div>
        <h3>${p.longTitle}</h3>
        <div class="size-row">
          <span class="size-label">× ×¤×—</span>
          <select class="size-select" aria-label="×‘×—×¨ × ×¤×—">
            <option value="" ${!selectedById[p.id]?'selected':''} disabled>×‘×—×¨ × ×¤×—â€¦</option>
            <option value="100" ${selectedById[p.id]==="100"?'selected':''}>100 ××´×œ</option>
            <option value="10"  ${selectedById[p.id]==="10" ?'selected':''}>10 ××´×œ (×›×•×œ×œ ×©×¤×¨×™×¦×¨)</option>
            <option value="5"   ${selectedById[p.id]==="5"  ?'selected':''}>5 ××´×œ</option>
          </select>
        </div>
        <div class="price" aria-live="polite">
          <span class="price-amount">â‚ª<span class="price-val">${vol100}</span></span>
          <span class="price-sep">Â·</span>
          <span class="price-size">100 ××´×œ</span>
        </div>
        <p class="size-note"></p>
        <a class="wa-btn ${selectedById[p.id] ? '' : 'disabled'}" href="#" target="_blank" rel="noopener">×”×–×× ×”/×©××œ×” ×‘-WhatsApp</a>
      </article>`;
  }).join('');

  document.querySelectorAll('.card').forEach(card=>{
    const pid=Number(card.dataset.id); const p=list.find(x=>x.id===pid);
    const select=card.querySelector('.size-select');
    const priceVal=card.querySelector('.price-val'); const priceSize=card.querySelector('.price-size'); const priceSep=card.querySelector('.price-sep');
    const noteEl=card.querySelector('.size-note'); const waBtn=card.querySelector('.wa-btn'); const box=card.querySelector('.imagebox');

    const dupeSlug=slugify(p.dupeName); const inspSlug=slugify(`${p.inspBrand} ${p.inspProduct}`.trim());
    buildCarousel(box, dupeSlug?`images/${dupeSlug}`:"", inspSlug?`images/${inspSlug}`:"");

    waBtn.addEventListener('click', (e)=>{ if(waBtn.classList.contains('disabled')){ e.preventDefault(); showToast('×‘×—×¨/×™ × ×¤×— ×§×•×“× ğŸ™‚', waBtn); } });

    if(selectedById[pid]) applySize(selectedById[pid]); else { priceVal.textContent=p.price["100"]; priceSize.textContent="100 ××´×œ"; }
    select.addEventListener('change', e=> applySize(e.target.value));

    function applySize(v){
      selectedById[pid]=v; const price=p.price[v];
      priceVal.textContent=price; const sizeHe=(v==="100"?"100 ××´×œ":v==="10"?"10 ××´×œ":"5 ××´×œ");
      priceSize.textContent=sizeHe; priceSep.style.display=price&&sizeHe?'inline':'none';
      if(v==="10"){ noteEl.textContent="×›×•×œ×œ ×©×¤×¨×™×¦×¨ ×œ××™×œ×•×™-××—×“×© (Refillable)"; noteEl.classList.add('show'); } else { noteEl.textContent=""; noteEl.classList.remove('show'); }
      waBtn.href = buildWaHref(p, sizeHe, price); waBtn.classList.remove('disabled');
    }
  });
}

/* -------- filters -------- */
function unique(list, getter){ return Array.from(new Set(list.map(getter).filter(Boolean))); }
function renderBrandOptions(list){
  const sel=document.getElementById('f-brand'); const prev=sel.value;
  sel.innerHTML=`<option value="">×”×›×œ</option>`;
  unique(list,p=>p.inspBrand).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; sel.appendChild(o); });
  if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
}
function applyFilters(all){
  const q=document.getElementById('f-q').value.trim().toLowerCase();
  const brand=document.getElementById('f-brand').value;
  const sort=document.getElementById('f-sort').value;
  let list = all.filter(p=>{
    const hay=(p.dupeName+" "+p.inspBrand+" "+p.inspProduct+" "+p.longTitle).toLowerCase();
    const okQ=!q || hay.includes(q); const okB=!brand || p.inspBrand===brand; return okQ && okB;
  });
  if(sort==='p_asc')  list=list.slice().sort((a,b)=>(a.price["100"]||0)-(b.price["100"]||0));
  if(sort==='p_desc') list=list.slice().sort((a,b)=>(b.price["100"]||0)-(a.price["100"]||0));
  renderProducts(list);
}

/* -------- map CSV row to product -------- */
function mapRow(row, idx){
  // prefer separate columns if exist, otherwise parse from long title
  const longTitleRaw = (row["×©× ××œ× ×›×•×ª×¨×ª"]||row["Title"]||row["name"]||"").trim();
  let dupeName=(row["×©× ××•×¦×¨ ×”×“×™×•×¤"]||"").trim();
  let inspBrand=(row["×©× ××•×ª×’ ×”×”×©×¨××”"]||"").trim();
  let inspProduct=(row["×©× ××•×¦×¨ ×”×”×©×¨××”"]||"").trim();
  let gender=(row["××™×Ÿ ××•××œ×¥ ×œ×‘×•×©×"]||"").trim();

  const parsed = parseFromLongTitle(longTitleRaw);
  // fill from parsed when fields missing/×¨×™×§×™×
  const longTitle = parsed.longTitle || longTitleRaw;
  if(!dupeName)     dupeName = parsed.dupeName;
  if(!inspBrand)    inspBrand = parsed.inspBrand;
  if(!inspProduct)  inspProduct = parsed.inspProduct;
  if(!gender)       gender = parsed.gender;

  const base = deriveBasePrice100(slugify(dupeName||longTitle||("p"+idx)));
  const price100=base, price10=derive10ml(base), price5=derive5ml(base);

  return {
    id: idx+1,
    longTitle,
    dupeName,
    inspBrand,
    inspProduct,
    gender,
    price: {"100":price100,"10":price10,"5":price5}
  };
}

/* -------- init -------- */
function initTopWA(){
  const waTop=document.getElementById('waTop');
  if(waTop) waTop.href=`https://wa.me/${WA_PHONE}?text=${encodeURIComponent('×”×™×™! ××¢×•× ×™×™×Ÿ/×ª ×‘×‘×©××™×. ××©××— ×œ×¤×¨×˜×™× ×¢×œ × ×¤×—×™× ×•×“×•×’××™×•×ª.')}`;
}
document.addEventListener('DOMContentLoaded', async ()=>{
  initTopWA();
  const {rows}=await loadCSV(CSV_URL);
  if(!rows.length){ console.warn("CSV ×¨×™×§ ××• ×œ× × ×˜×¢×Ÿ"); document.getElementById('empty').style.display='block'; return; }
  const ALL = rows.map(mapRow);
  renderBrandOptions(ALL);
  renderProducts(ALL);
  document.getElementById('f-q').addEventListener('input', ()=>applyFilters(ALL));
  document.getElementById('f-brand').addEventListener('change', ()=>applyFilters(ALL));
  document.getElementById('f-sort').addEventListener('change', ()=>applyFilters(ALL));
});
</script>
</body>
</html>
